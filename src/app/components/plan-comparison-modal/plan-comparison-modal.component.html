<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Seleccionar Plan</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="plan-selection-content">
  <div class="plans-list-container">
    
    <!-- Gestión de servicios (cuando el nuevo plan tiene menos límite) -->
    <div class="services-management-section" *ngIf="showServicesManagement">
      <div class="section-header">
        <h2>Ajustar Servicios</h2>
        <p>
          El plan <strong>{{ selectedPlan?.name }}</strong> permite máximo 
          <strong>{{ getLimitDisplay(selectedPlan?.limits?.services || 0) }}</strong> servicio(s).
          Actualmente tienes <strong>{{ userProviders.length }}</strong> servicio(s).
        </p>
        <p class="warning-text">
          <ion-icon name="warning-outline"></ion-icon>
          Debes eliminar <strong>{{ requiredDeletions }}</strong> servicio(s) para continuar con este plan.
        </p>
      </div>

      <div class="services-list">
        <div 
          *ngFor="let provider of userProviders"
          class="service-card"
          [class.selected]="isServiceSelectedForDeletion(provider._id)"
          [class.disabled]="!isServiceSelectedForDeletion(provider._id) && !canSelectMoreServices()"
          (click)="toggleServiceSelection(provider._id)"
        >
          <div class="service-check" *ngIf="isServiceSelectedForDeletion(provider._id)">
            <ion-icon name="checkmark-circle" color="danger"></ion-icon>
          </div>
          <div class="service-content">
            <div class="service-logo">
              <img [src]="provider.logo || '/assets/images/default-business.png'" [alt]="provider.name" 
                   (error)="$any($event.target).src='/assets/images/default-business.png'">
            </div>
            <div class="service-info">
              <h3>{{ provider.name }}</h3>
              <p *ngIf="provider.description">{{ provider.description }}</p>
              <ion-badge *ngIf="isServiceSelectedForDeletion(provider._id)" color="danger">
                Se eliminará
              </ion-badge>
            </div>
          </div>
        </div>
      </div>

      <div class="services-selection-info">
        <ion-note>
          <ion-icon name="information-circle-outline"></ion-icon>
          Seleccionados: <strong>{{ servicesToDelete.length }}</strong> de <strong>{{ requiredDeletions }}</strong> servicios
        </ion-note>
      </div>
    </div>

    <!-- Lista de planes -->
    <div class="plans-list" *ngIf="!showPaymentMethods && !showServicesManagement">
      <div 
        *ngFor="let plan of availablePlans" 
        class="plan-card"
        [class.selected]="isPlanSelected(plan.code)"
        [class.current]="isCurrentPlan(plan.code)"
        (click)="selectPlan(plan)"
      >
        <!-- Badge Plan Actual -->
        <div class="current-badge" *ngIf="isCurrentPlan(plan.code)">
          <ion-icon name="checkmark-circle"></ion-icon>
          <span>Plan Actual</span>
        </div>

        <!-- Check de selección -->
        <div class="selection-check" *ngIf="isPlanSelected(plan.code)">
          <ion-icon name="checkmark-circle" color="primary"></ion-icon>
        </div>

        <div class="plan-content">
          <!-- Header del plan -->
          <div class="plan-header-section">
            <h2 class="plan-name">{{ plan.name }}</h2>
            <div class="plan-price">
              <span *ngIf="plan.price === 0" class="price-free">Gratis</span>
              <span *ngIf="plan.price > 0">
                <span class="currency">$</span>
                <span class="amount">{{ plan.price }}</span>
                <span class="period">/mes</span>
              </span>
            </div>
          </div>

          <!-- Descripción -->
          <p class="plan-description">{{ plan.description }}</p>

          <!-- Características del plan -->
          <div class="plan-features">
            <div class="feature-item">
              <ion-icon name="business-outline"></ion-icon>
              <span><strong>Servicios:</strong> {{ getLimitDisplay(plan.limits.services) }}</span>
            </div>
            <div class="feature-item">
              <ion-icon name="megaphone-outline"></ion-icon>
              <span><strong>Promociones por servicio:</strong> {{ getLimitDisplay(plan.limits.promotionsPerService) }}</span>
            </div>
            <div class="feature-item">
              <ion-icon name="cube-outline"></ion-icon>
              <span><strong>Productos por servicio:</strong> {{ getLimitDisplay(plan.limits.productsPerService) }}</span>
            </div>
            <div class="feature-item" *ngIf="plan.features?.analytics">
              <ion-icon name="analytics-outline"></ion-icon>
              <span>Analíticas avanzadas</span>
            </div>
            <div class="feature-item" *ngIf="plan.features?.prioritySupport">
              <ion-icon name="headset-outline"></ion-icon>
              <span>Soporte prioritario</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selección de método de pago -->
    <div class="payment-methods-section" *ngIf="showPaymentMethods && selectedPlan">
      <div class="section-header">
        <h2>Método de Pago</h2>
        <p>Selecciona cómo deseas pagar tu plan <strong>{{ selectedPlan.name }}</strong></p>
      </div>

      <div class="payment-methods-list">
        <div 
          *ngFor="let method of paymentMethods"
          class="payment-method-card"
          [class.selected]="selectedPaymentMethod?.code === method.code"
          (click)="selectPaymentMethod(method)"
        >
          <div class="method-check" *ngIf="selectedPaymentMethod?.code === method.code">
            <ion-icon name="checkmark-circle" color="primary"></ion-icon>
          </div>
          <div class="method-content">
            <h3>{{ method.name }}</h3>
            <p>{{ method.description }}</p>
          </div>
        </div>
      </div>

      <!-- Mostrar datos de pago cuando se selecciona un método -->
      <div class="payment-data-section" *ngIf="selectedPaymentMethod && selectedPaymentMethod.paymentData">
        <div class="payment-data-card">
          <div class="payment-data-header">
            <ion-icon name="information-circle-outline" color="primary"></ion-icon>
            <h3>Datos para Realizar el Pago</h3>
          </div>
          <div class="payment-data-content">
            
            <!-- Pago Móvil / Transferencia -->
            <ng-container *ngIf="selectedPaymentMethod.paymentData.type === 'pago_movil' || (!selectedPaymentMethod.paymentData.type && selectedPaymentMethod.paymentData.bank)">
              <div class="payment-data-item" *ngIf="selectedPaymentMethod.paymentData.bank">
                <ion-icon name="business-outline"></ion-icon>
                <div>
                  <strong>Banco:</strong>
                  <span>{{ selectedPaymentMethod.paymentData.bank }}</span>
                </div>
              </div>
              <div class="payment-data-item" *ngIf="selectedPaymentMethod.paymentData.phoneNumber">
                <ion-icon name="call-outline"></ion-icon>
                <div>
                  <strong>Teléfono:</strong>
                  <span>{{ selectedPaymentMethod.paymentData.phoneNumber }}</span>
                </div>
              </div>
              <div class="payment-data-item" *ngIf="selectedPaymentMethod.paymentData.identificationNumber">
                <ion-icon name="card-outline"></ion-icon>
                <div>
                  <strong>Documento:</strong>
                  <span>{{ selectedPaymentMethod.paymentData.identificationNumber }}</span>
                </div>
              </div>
            </ng-container>

            <!-- Binance Pay -->
            <ng-container *ngIf="selectedPaymentMethod.paymentData.type === 'binance' || selectedPaymentMethod.paymentData.email">
              <div class="payment-data-item" *ngIf="selectedPaymentMethod.paymentData.email">
                <ion-icon name="mail-outline"></ion-icon>
                <div>
                  <strong>Correo:</strong>
                  <span>{{ selectedPaymentMethod.paymentData.email }}</span>
                </div>
              </div>
              <div class="payment-data-item" *ngIf="selectedPaymentMethod.paymentData.binanceId">
                <ion-icon name="wallet-outline"></ion-icon>
                <div>
                  <strong>ID Binance:</strong>
                  <span>{{ selectedPaymentMethod.paymentData.binanceId }}</span>
                </div>
              </div>
            </ng-container>

          </div>
          <ion-note class="payment-data-note">
            <ion-icon name="warning-outline"></ion-icon>
            Realiza el pago con estos datos y luego repórtalo desde tu perfil
          </ion-note>
        </div>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="action-section">
      <!-- Botones para gestión de servicios -->
      <div *ngIf="showServicesManagement" class="services-actions">
        <ion-button 
          expand="block" 
          fill="outline"
          color="medium"
          (click)="goBackToPlansFromServices()"
          class="back-button"
        >
          <ion-icon name="arrow-back" slot="start"></ion-icon>
          Volver
        </ion-button>
        
        <ion-button 
          expand="block" 
          size="large"
          color="danger"
          [disabled]="servicesToDelete.length !== requiredDeletions || isLoading"
          (click)="deleteServicesAndContinue()"
          class="delete-services-button"
        >
          <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
          <span *ngIf="!isLoading">
            Eliminar {{ requiredDeletions }} servicio(s) y continuar
          </span>
        </ion-button>
      </div>

      <!-- Botón para continuar con el plan -->
      <ion-button 
        *ngIf="!showPaymentMethods && !showServicesManagement"
        expand="block" 
        size="large"
        color="primary"
        [disabled]="!selectedPlan || isLoading"
        (click)="continueToPayment()"
        class="continue-button"
      >
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <span *ngIf="!isLoading">
          <span *ngIf="selectedPlan && selectedPlan.price === 0">Activar Plan Gratuito</span>
          <span *ngIf="selectedPlan && selectedPlan.price > 0">Continuar con {{ selectedPlan.name }}</span>
          <span *ngIf="!selectedPlan">Selecciona un Plan</span>
        </span>
      </ion-button>

      <!-- Botones para método de pago -->
      <div *ngIf="showPaymentMethods" class="payment-actions">
        <ion-button 
          expand="block" 
          fill="outline"
          color="medium"
          (click)="goBackToPlans()"
          class="back-button"
        >
          <ion-icon name="arrow-back" slot="start"></ion-icon>
          Volver
        </ion-button>
        
        <ion-button 
          expand="block" 
          size="large"
          color="primary"
          [disabled]="!selectedPaymentMethod || isLoading"
          (click)="requestPlanWithPayment()"
          class="request-plan-button"
        >
          <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
          <span *ngIf="!isLoading">Solicitar Plan</span>
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>

