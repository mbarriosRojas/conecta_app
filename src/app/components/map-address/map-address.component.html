<ion-card class="map-address-card" *ngIf="!hideHeader">
  <ion-card-header>
    <ion-card-title>
      <ion-icon name="location-outline"></ion-icon>
      Ubicaci贸n
    </ion-card-title>
  </ion-card-header>
  
  <ion-card-content>
    <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
  </ion-card-content>
</ion-card>

<!-- Versi贸n sin card cuando hideHeader es true -->
<div class="map-address-content" *ngIf="hideHeader">
  <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
</div>

<!-- Template del contenido para evitar duplicaci贸n -->
<ng-template #contentTemplate>
  <!-- Campo de b煤squeda de direcci贸n -->
  <div class="search-container">
    <ion-item class="address-search-item">
      <ion-input
        #addressInput
        placeholder="Buscar direcci贸n..."
        [(ngModel)]="addressData.street"
        (ionInput)="onAddressSearch($event)"
        (ionBlur)="onInputBlur()"
        clearInput="true">
      </ion-input>
      <ion-icon name="search-outline" slot="end" color="medium"></ion-icon>
    </ion-item>

    <!-- Sugerencias de autocompletado -->
    <div class="suggestions-container" *ngIf="showSuggestions && searchSuggestions.length > 0">
      <ion-list>
        <ion-item 
          *ngFor="let suggestion of searchSuggestions" 
          button
          (click)="selectSuggestion(suggestion)"
          class="suggestion-item">
          <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>{{ suggestion.structured_formatting.main_text }}</h3>
            <p>{{ suggestion.structured_formatting.secondary_text }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>
  </div>

  <!-- Mapa -->
  <div class="map-container" *ngIf="showMap">
      <!-- Instrucciones informativas -->
      <div class="map-instructions">
        <div class="instruction-card">
          <ion-icon name="information-circle-outline"></ion-icon>
          <div class="instruction-content">
            <p><strong>Busca tu direcci贸n</strong> usando el campo de b煤squeda o <strong>arrastra el marcador rojo</strong> en el mapa para ajustar la ubicaci贸n exacta.</p>
          </div>
        </div>
      </div>
    
    <div 
      id="addressMap" 
      class="address-map"
      [style.height]="height">
      <!-- Indicador de carga -->
      <div *ngIf="isMapLoading" class="map-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando mapa...</p>
      </div>
    </div>
    
  </div>

  <!-- Informaci贸n de la direcci贸n seleccionada -->
  <div class="address-info" *ngIf="addressData.formattedAddress">
    
    <ion-item>
      <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
      <ion-label>
        <h3>Direcci贸n seleccionada</h3>
        <p>{{ addressData.formattedAddress }}</p>
      </ion-label>
    </ion-item>
  </div>

  <!-- Campos de direcci贸n (solo lectura) -->
  <div class="address-fields">
    <ion-item>
      <ion-label position="stacked">Direcci贸n *</ion-label>
      <ion-input 
        [value]="addressData.street" 
        readonly
        placeholder="Selecciona una direcci贸n en el mapa">
      </ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Ciudad *</ion-label>
      <ion-input 
        [value]="addressData.city" 
        readonly
        placeholder="Se detectar谩 autom谩ticamente">
      </ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Departamento</ion-label>
      <ion-input 
        [value]="addressData.department" 
        readonly
        placeholder="Se detectar谩 autom谩ticamente">
      </ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Pa铆s</ion-label>
      <ion-input 
        [value]="addressData.country" 
        readonly>
      </ion-input>
    </ion-item>
  </div>

  <!-- Botones de acci贸n -->
  <div class="action-buttons">
    <ion-button 
      expand="block" 
      fill="outline" 
      color="primary"
      (click)="useCurrentLocation()"
      class="location-button">
      <ion-icon name="locate" slot="start"></ion-icon>
      Usar mi ubicaci贸n actual
    </ion-button>

    <!--  MEJORADO: Bot贸n de confirmaci贸n ahora opcional y menos prominente -->
    <!-- La direcci贸n se confirma autom谩ticamente al seleccionar o mover el marcador -->
    <ion-button 
      expand="block" 
      fill="outline" 
      color="medium"
      (click)="confirmAddress()"
      [disabled]="!addressData.street || !addressData.city"
      class="confirm-button">
      <ion-icon name="checkmark" slot="start"></ion-icon>
      Confirmar manualmente (opcional)
    </ion-button>
    
    <!-- Mensaje informativo -->
    <ion-note color="medium" class="auto-confirm-note">
      <ion-icon name="information-circle-outline"></ion-icon>
      <span>La ubicaci贸n se confirma autom谩ticamente al seleccionar o mover el marcador</span>
    </ion-note>
  </div>
</ng-template>
