<ion-header [translucent]="false">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/services" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Crear Servicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false">
  <form (ngSubmit)="onSubmit()" #serviceForm="ngForm">
    
    <!-- Información básica - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('basic')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="information-circle-outline"></ion-icon>
          Información Básica
        </ion-card-title>
        <ion-icon [name]="expandedSections.basic ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.basic" class="expandable-content">
        <ion-item>
          <ion-label position="stacked">Nombre del servicio *</ion-label>
          <ion-input [(ngModel)]="formData.name" name="name" required></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Descripción *</ion-label>
          <ion-textarea [(ngModel)]="formData.description" name="description" required rows="4"></ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Categoría *</ion-label>
          <ion-select [(ngModel)]="formData.categoryId" name="categoryId" required>
            <ion-select-option *ngFor="let category of categories" [value]="category._id">
              {{ category.name }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Contacto - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('contact')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="call-outline"></ion-icon>
          Información de Contacto
        </ion-card-title>
        <ion-icon [name]="expandedSections.contact ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.contact" class="expandable-content">
        <ion-item>
          <ion-label position="stacked">Teléfono de contacto *</ion-label>
          <ion-input [(ngModel)]="formData.phone_contact" name="phone_contact" type="tel" required></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Teléfono adicional</ion-label>
          <ion-input [(ngModel)]="formData.phone_number" name="phone_number" type="tel"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Email</ion-label>
          <ion-input [(ngModel)]="formData.email" name="email" type="email"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Sitio web</ion-label>
          <ion-input [(ngModel)]="formData.site_web" name="site_web" type="url" placeholder="https://"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Redes sociales - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('social')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="share-social-outline"></ion-icon>
          Redes Sociales
        </ion-card-title>
        <ion-icon [name]="expandedSections.social ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.social" class="expandable-content">
        <ion-item>
          <ion-label position="stacked">Facebook</ion-label>
          <ion-input [(ngModel)]="formData.facebook" name="facebook" placeholder="https://facebook.com/mi-pagina"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Instagram</ion-label>
          <ion-input [(ngModel)]="formData.instagram" name="instagram" placeholder="https://instagram.com/mi-cuenta"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">TikTok</ion-label>
          <ion-input [(ngModel)]="formData.tiktok" name="tiktok" placeholder="https://tiktok.com/@mi-cuenta"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">LinkedIn</ion-label>
          <ion-input [(ngModel)]="formData.linkedin" name="linkedin" placeholder="https://linkedin.com/in/mi-perfil"></ion-input>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Dirección con Mapa -->
    <app-map-address
      [initialAddress]="initialAddressData"
      [height]="'250px'"
      (addressSelected)="onAddressSelected($event)"
      (addressChanged)="onAddressChanged($event)">
    </app-map-address>

    <!-- Horarios - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('schedule')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="time-outline"></ion-icon>
          Horarios de Atención
        </ion-card-title>
        <ion-icon [name]="expandedSections.schedule ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.schedule" class="expandable-content">
        <div *ngFor="let schedule of formData.schedule; let i = index" class="schedule-item">
          <ion-item>
            <ion-checkbox [(ngModel)]="schedule.active" name="schedule{{i}}active"></ion-checkbox>
            <ion-label>{{ schedule.day }}</ion-label>
          </ion-item>
          
          <div *ngIf="schedule.active" class="schedule-times">
            <ion-item>
              <ion-label position="stacked">Hora de inicio</ion-label>
              <ion-input [(ngModel)]="schedule.start" name="start{{i}}" type="time"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Hora de cierre</ion-label>
              <ion-input [(ngModel)]="schedule.end" name="end{{i}}" type="time"></ion-input>
            </ion-item>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Preguntas frecuentes - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('questions')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="help-circle-outline"></ion-icon>
          Preguntas Frecuentes
        </ion-card-title>
        <ion-icon [name]="expandedSections.questions ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.questions" class="expandable-content">
        <div *ngFor="let question of formData.questions; let i = index" class="question-item">
          <ion-item>
            <ion-label position="stacked">Pregunta</ion-label>
            <ion-input [(ngModel)]="question.question" name="question{{i}}"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Respuesta</ion-label>
            <ion-textarea [(ngModel)]="question.answer" name="answer{{i}}" rows="3"></ion-textarea>
          </ion-item>

          <ion-button fill="clear" color="danger" (click)="removeQuestion(i)" *ngIf="formData.questions.length > 1">
            <ion-icon name="trash" slot="start"></ion-icon>
            Eliminar
          </ion-button>
        </div>

        <ion-button fill="outline" (click)="addQuestion()">
          <ion-icon name="add" slot="start"></ion-icon>
          Agregar pregunta
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Imágenes - Sección desplegable -->
    <ion-card class="expandable-card">
      <ion-card-header (click)="toggleSection('images')" class="expandable-header">
        <ion-card-title>
          <ion-icon name="images-outline"></ion-icon>
          Imágenes del Servicio
        </ion-card-title>
        <ion-icon [name]="expandedSections.images ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
      </ion-card-header>
      <ion-card-content *ngIf="expandedSections.images" class="expandable-content">
        
        <!-- Logo del servicio -->
        <div class="image-upload-section">
          <ion-label class="section-label">Logo del servicio</ion-label>
          
          <div class="image-preview-container">
            <div class="image-preview" *ngIf="logoPreview">
              <img [src]="logoPreview" alt="Logo preview" class="preview-image">
              <ion-button 
                fill="clear" 
                color="danger" 
                size="small" 
                class="remove-image-btn"
                (click)="removeLogo()">
                <ion-icon name="trash"></ion-icon>
              </ion-button>
            </div>
            
            <div class="upload-area" *ngIf="!logoPreview" (click)="triggerLogoUpload()">
              <ion-icon name="add-circle-outline" size="large" color="medium"></ion-icon>
              <p>Seleccionar logo</p>
            </div>
          </div>
          
          <input 
            #logoInput
            type="file" 
            accept="image/*" 
            (change)="onLogoSelected($event)"
            style="display: none;">
        </div>

        <!-- Imágenes del servicio -->
        <div class="image-upload-section">
          <ion-label class="section-label">Imágenes del servicio *</ion-label>
          
          <div class="images-grid">
            <div class="image-preview" *ngFor="let image of imagesPreviews; let i = index">
              <img [src]="image" alt="Image preview" class="preview-image">
              <ion-button 
                fill="clear" 
                color="danger" 
                size="small" 
                class="remove-image-btn"
                (click)="removeImage(i)">
                <ion-icon name="trash"></ion-icon>
              </ion-button>
            </div>
            
            <div class="upload-area" *ngIf="imagesPreviews.length < 10" (click)="triggerImagesUpload()">
              <ion-icon name="add-circle-outline" size="large" color="medium"></ion-icon>
              <p>Agregar imagen</p>
            </div>
          </div>
          
          <input 
            #imagesInput
            type="file" 
            accept="image/*" 
            multiple
            (change)="onImagesSelected($event)"
            style="display: none;">
        </div>

        <ion-note color="medium">
          <p>• Selecciona al menos una imagen del servicio</p>
          <p>• Formatos recomendados: JPG, PNG</p>
          <p>• Tamaño máximo: 5MB por imagen</p>
          <p>• Máximo 10 imágenes</p>
        </ion-note>
      </ion-card-content>
    </ion-card>

    <!-- Botones de acción -->
    <div class="action-buttons">
      <ion-button expand="block" fill="solid" color="primary" type="submit" [disabled]="isLoading">
        <ion-icon name="checkmark" slot="start" *ngIf="!isLoading"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        {{ isLoading ? 'Creando...' : 'Crear Servicio' }}
      </ion-button>

      <ion-button expand="block" fill="outline" (click)="router.navigate(['/tabs/services'])" [disabled]="isLoading">
        Cancelar
      </ion-button>
    </div>

  </form>
</ion-content>
