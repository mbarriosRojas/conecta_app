<ion-header [translucent]="false">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/services" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Editar Servicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false">
  <div *ngIf="!provider" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando servicio...</p>
  </div>

  <form *ngIf="provider" (ngSubmit)="onSubmit()" #serviceForm="ngForm">
    
    <!-- Contenedor principal con estilo WhatsApp -->
    <div class="whatsapp-container">
      
      <!-- Secci√≥n: Informaci√≥n del Servicio - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('basic')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="business-outline"></ion-icon>
            Informaci√≥n del Servicio
          </ion-card-title>
          <ion-icon [name]="expandedSections.basic ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.basic" class="expandable-content">
          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="business"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Nombre del servicio</div>
              <ion-input [(ngModel)]="formData.name" name="name" required placeholder="Nombre de tu servicio"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="document-text"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Descripci√≥n</div>
              <ion-textarea [(ngModel)]="formData.description" name="description" required rows="3" placeholder="Describe tu servicio"></ion-textarea>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="grid"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Categor√≠a</div>
              <ion-select [(ngModel)]="formData.categoryId" name="categoryId" required placeholder="Selecciona una categor√≠a">
                <ion-select-option *ngFor="let category of categories" [value]="category._id">
                  {{ category.name }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Informaci√≥n de Contacto - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('contact')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="call-outline"></ion-icon>
            Informaci√≥n de Contacto
          </ion-card-title>
          <ion-icon [name]="expandedSections.contact ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.contact" class="expandable-content">
          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="call"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Tel√©fono de contacto</div>
              <ion-input [(ngModel)]="formData.phone_contact" name="phone_contact" type="tel" required placeholder="N√∫mero principal"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="phone-portrait"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Tel√©fono adicional</div>
              <ion-input [(ngModel)]="formData.phone_number" name="phone_number" type="tel" placeholder="N√∫mero secundario"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="mail"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Email</div>
              <ion-input [(ngModel)]="formData.email" name="email" type="email" placeholder="correo@ejemplo.com"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon">
              <ion-icon name="globe"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Sitio web</div>
              <ion-input [(ngModel)]="formData.site_web" name="site_web" type="url" placeholder="https://mi-sitio.com"></ion-input>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Redes Sociales - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('social')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="share-social-outline"></ion-icon>
            Redes Sociales
          </ion-card-title>
          <ion-icon [name]="expandedSections.social ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.social" class="expandable-content">
          <div class="settings-item">
            <div class="item-icon facebook">
              <ion-icon name="logo-facebook"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Facebook</div>
              <ion-input [(ngModel)]="formData.facebook" name="facebook" placeholder="https://facebook.com/mi-pagina"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon instagram">
              <ion-icon name="logo-instagram"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">Instagram</div>
              <ion-input [(ngModel)]="formData.instagram" name="instagram" placeholder="https://instagram.com/mi-cuenta"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon tiktok">
              <ion-icon name="logo-tiktok"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">TikTok</div>
              <ion-input [(ngModel)]="formData.tiktok" name="tiktok" placeholder="https://tiktok.com/@mi-cuenta"></ion-input>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon linkedin">
              <ion-icon name="logo-linkedin"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label">LinkedIn</div>
              <ion-input [(ngModel)]="formData.linkedin" name="linkedin" placeholder="https://linkedin.com/in/mi-perfil"></ion-input>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n Mantenimiento: Ubicaci√≥n - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('location')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="location-outline"></ion-icon>
            Ubicaci√≥n
          </ion-card-title>
          <ion-icon [name]="expandedSections.location ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.location" class="expandable-content">
          <div class="settings-item location-item">
            <div class="location-map-container">
              <app-map-address
                [initialAddress]="initialAddressData"
                [height]="'200px'"
                (addressSelected)="onAddressSelected($event)"
                (addressChanged)="onAddressChanged($event)">
              </app-map-address>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Productos y Servicios - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('products')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="cube-outline"></ion-icon>
            Productos y Servicios
            <span *ngIf="products.length > 0" class="item-count">{{ products.length }}</span>
          </ion-card-title>
          <ion-icon [name]="expandedSections.products ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.products" class="expandable-content">
          <div class="settings-item">
            <div class="item-icon" (click)="openProductModal()">
              <ion-icon name="add-circle"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label add-new"(click)="openProductModal()">Agregar nuevo producto</div>
            </div>
          </div>

          <!-- Lista de productos -->
          <div *ngIf="products.length === 0" class="no-products">
            <div class="no-products-content">
              <ion-icon name="cube-outline"></ion-icon>
              <p>No hay productos registrados</p>
              <ion-button fill="outline" (click)="openProductModal()">
                <ion-icon name="add" slot="start"></ion-icon>
                Agregar primer producto
              </ion-button>
            </div>
          </div>

          <div *ngIf="products.length > 0" class="products-container">
            <!-- Buscador de productos -->
            <div class="product-search">
              <ion-searchbar 
                [(ngModel)]="productSearchQuery" 
                (ionInput)="filterProducts()"
                placeholder="Buscar productos por nombre..."
                show-clear-button="focus">
              </ion-searchbar>
            </div>

            <!-- Scroll de fotos de productos -->
            <div class="products-photos-scroll">
              <div class="products-photos-container">
                <div *ngFor="let product of filteredProducts; let i = index" 
                     class="product-photo-item" 
                     (click)="selectProduct(product)"
                     [class.selected]="selectedProduct?.id === product.id">
                  <div class="product-photo">
                    <img *ngIf="product.images && product.images.length > 0" 
                         [src]="product.images[0]" 
                         [alt]="product.name"
                         (error)="onImageError($event)">
                    <div *ngIf="!product.images || product.images.length === 0" class="no-image">
                      <ion-icon name="cube-outline"></ion-icon>
                    </div>
                  </div>
                  <div class="product-photo-name">{{ product.name }}</div>
                </div>
              </div>
            </div>

            <!-- Lista de productos -->
            <div class="products-list">
              <div *ngFor="let product of filteredProducts; let i = index" class="product-item">
                <div class="product-info">
                  <div class="product-name">{{ product.name }}</div>
                  <div class="product-description">{{ product.description }}</div>
                  <div class="product-details">
                    <span class="product-category">{{ product.category }}</span>
                    <span *ngIf="product.price" class="product-price">${{ product.price | number }}</span>
                    <span *ngIf="!product.price" class="product-price-consult">Consultar precio</span>
                    <span *ngIf="product.featured" class="product-featured">‚≠ê Destacado</span>
                  </div>
                </div>
                <div class="product-actions">
                  <ion-button fill="clear" (click)="editProduct(product)">
                    <ion-icon name="create"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" color="danger" (click)="deleteProduct(product._id, i)">
                    <ion-icon name="trash"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Horarios de Atenci√≥n - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('schedule')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="time-outline"></ion-icon>
            Horarios de Atenci√≥n
          </ion-card-title>
          <ion-icon [name]="expandedSections.schedule ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.schedule" class="expandable-content">
          <div *ngFor="let schedule of formData.schedule; let i = index" class="schedule-item">
            <div class="settings-item">
              <div class="item-icon">
                <ion-icon name="time"></ion-icon>
              </div>
              <div class="item-content">
                <div class="schedule-day">
                  <ion-checkbox [(ngModel)]="schedule.active" name="schedule{{i}}active"></ion-checkbox>
                  <span class="day-name">{{ schedule.day }}</span>
                </div>
                
                <div *ngIf="schedule.active" class="schedule-times">
                  <div class="time-inputs">
                    <div class="time-input">
                      <label>Inicio</label>
                      <ion-input [(ngModel)]="schedule.start" name="start{{i}}" type="time"></ion-input>
                    </div>
                    <div class="time-input">
                      <label>Cierre</label>
                      <ion-input [(ngModel)]="schedule.end" name="end{{i}}" type="time"></ion-input>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Preguntas Frecuentes - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('questions')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="help-circle-outline"></ion-icon>
            Preguntas Frecuentes
            <span *ngIf="formData.questions.length > 1" class="item-count">{{ formData.questions.length }}</span>
          </ion-card-title>
          <ion-icon [name]="expandedSections.questions ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.questions" class="expandable-content">
          <div *ngFor="let question of formData.questions; let i = index" class="question-item">
            <div class="settings-item">
              <div class="item-icon">
                <ion-icon name="help-circle"></ion-icon>
              </div>
              <div class="item-content">
                <div class="question-content">
                  <div class="question-input">
                    <label>Pregunta</label>
                    <ion-input [(ngModel)]="question.question" name="question{{i}}" placeholder="¬øCu√°l es tu pregunta?"></ion-input>
                  </div>

                  <div class="answer-input">
                    <label>Respuesta</label>
                    <ion-textarea [(ngModel)]="question.answer" name="answer{{i}}" rows="2" placeholder="Escribe la respuesta aqu√≠"></ion-textarea>
                  </div>

                  <ion-button fill="clear" color="danger" (click)="removeQuestion(i)" *ngIf="formData.questions.length > 1">
                    <ion-icon name="trash" slot="start"></ion-icon>
                    Eliminar
                  </ion-button>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-item">
            <div class="item-icon" (click)="addQuestion()">
              <ion-icon name="add-circle"></ion-icon>
            </div>
            <div class="item-content">
              <div class="item-label add-new" (click)="addQuestion()">Agregar nueva pregunta</div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Im√°genes del Servicio - Card expandible -->
      <ion-card class="expandable-card">
        <ion-card-header (click)="toggleSection('images')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="images-outline"></ion-icon>
            Im√°genes del Servicio
            <span *ngIf="provider?.images && provider.images.length > 0" class="item-count">{{ provider.images.length }}</span>
          </ion-card-title>
          <ion-icon [name]="expandedSections.images ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.images" class="expandable-content">
          <!-- Logo actual -->
          <div *ngIf="provider?.logo" class="current-logo-section">
            <div class="settings-item">
              <div class="item-icon">
                <ion-icon name="image"></ion-icon>
              </div>
              <div class="item-content">
                <div class="item-label">Logo Actual</div>
                <div class="current-logo">
                  <img [src]="provider.logo" [alt]="provider.name + ' logo'" class="current-logo-image">
                  <ion-button fill="clear" color="danger" size="small" (click)="deleteLogo()">
                    <ion-icon name="trash"></ion-icon>
                    Eliminar logo
                  </ion-button>
                </div>
              </div>
            </div>
          </div>

          <!-- Im√°genes actuales -->
          <div *ngIf="provider?.images && provider.images.length > 0" class="current-images-section">
            <div class="settings-item">
              <div class="item-icon">
                <ion-icon name="images"></ion-icon>
              </div>
              <div class="item-content">
                <div class="item-label">Im√°genes Actuales</div>
                <div class="current-images">
                  <div *ngFor="let image of provider.images; let i = index" class="image-item">
                    <img [src]="image" [alt]="provider.name" class="current-image">
                    <ion-button fill="clear" color="danger" size="small" (click)="deleteImage(image, i)">
                      <ion-icon name="trash"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Subir nuevas im√°genes -->
          <div class="new-images-section">
            <!-- Bot√≥n de logo - solo visible cuando no hay logo o se elimin√≥ -->
            <div *ngIf="showLogoButton" class="settings-item">
              <div class="item-icon">
                <ion-icon name="camera"></ion-icon>
              </div>
              <div class="item-content">
                <div class="item-label">Logo del servicio</div>
                <ion-button fill="outline" (click)="selectLogo()">
                  <ion-icon name="camera" slot="start"></ion-icon>
                  {{ selectedLogo ? 'Cambiar logo' : 'Seleccionar logo' }}
                </ion-button>
                <p *ngIf="!selectedLogo" class="no-file-selected">Ning√∫n archivo seleccionado</p>
                <p *ngIf="selectedLogo" class="file-selected">
                  <ion-icon name="checkmark-circle" color="success"></ion-icon>
                  {{ selectedLogo.name }}
                </p>
              </div>
            </div>

            <!-- Bot√≥n de im√°genes - solo visible cuando no hay im√°genes o se eliminaron todas -->
            <div *ngIf="showImagesButton" class="settings-item">
              <div class="item-icon">
                <ion-icon name="images"></ion-icon>
              </div>
              <div class="item-content">
                <div class="item-label">Im√°genes del servicio</div>
                <ion-button fill="outline" (click)="selectImages()">
                  <ion-icon name="images" slot="start"></ion-icon>
                  {{ selectedImages.length > 0 ? 'Agregar m√°s im√°genes' : 'Seleccionar im√°genes' }}
                </ion-button>
                <p *ngIf="selectedImages.length === 0" class="no-file-selected">Ning√∫n archivo seleccionado</p>
                <div *ngIf="selectedImages.length > 0" class="selected-files">
                  <p class="file-selected">
                    <ion-icon name="checkmark-circle" color="success"></ion-icon>
                    {{ selectedImages.length }} imagen(es) seleccionada(s)
                  </p>
                </div>
              </div>
            </div>

            <ion-note color="medium">
              <p>‚Ä¢ Formatos recomendados: JPG, PNG</p>
              <p>‚Ä¢ Tama√±o m√°ximo: 5MB por imagen</p>
              <p>‚Ä¢ Las nuevas im√°genes se agregar√°n a las existentes</p>
            </ion-note>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Secci√≥n: Geomarketing - Card expandible -->
      <ion-card class="expandable-card" *ngIf="provider">
        <ion-card-header (click)="toggleSection('geofencing')" class="expandable-header">
          <ion-card-title>
            <ion-icon name="location-outline"></ion-icon>
            Geomarketing
          </ion-card-title>
          <ion-icon [name]="expandedSections.geofencing ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
        </ion-card-header>
        <ion-card-content *ngIf="expandedSections.geofencing" class="expandable-content">
        
        <!-- Estad√≠sticas de Geofencing -->
        <div class="geofencing-stats-card" *ngIf="geofenceStats">
          <div class="stats-header">
            <h3>Estad√≠sticas de Tu Geocerca</h3>
            <ion-button fill="clear" size="small" (click)="loadGeofenceStats()">
              <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
          </div>

          <div class="promotion-stats-grid">
            <div class="promotion-stat-card">
              <div class="stat-icon">
                <ion-icon name="people-outline" color="success"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ geofenceStats.audience?.activeUsers4h || 0 }}</div>
                <div class="stat-label">Usuarios Activos (4h)</div>
              </div>
            </div>

            <div class="promotion-stat-card">
              <div class="stat-icon">
                <ion-icon name="trending-up-outline" color="success"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ geofenceStats.performance?.totalEntries || 0 }}</div>
                <div class="stat-label">Entradas Totales</div>
              </div>
            </div>

            <div class="promotion-stat-card">
              <div class="stat-icon">
                <ion-icon name="megaphone-outline" color="success"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ geofenceStats.audience?.estimatedReach || 0 }}</div>
                <div class="stat-label">Alcance Estimado</div>
              </div>
            </div>

            <div class="promotion-stat-card">
              <div class="stat-icon">
                <ion-icon name="calendar-outline" color="success"></ion-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ geofenceStats.performance?.avgUsersPerDay || 0 }}</div>
                <div class="stat-label">Promedio Diario</div>
              </div>
            </div>
          </div>

          <div class="geofence-info" *ngIf="geofenceStats.geofence">
            <ion-item lines="none">
              <ion-icon name="location-outline" slot="start" color="success"></ion-icon>
              <ion-label>
                <h3>Radio Activo</h3>
                <p>{{ geofenceStats.geofence.radius }}m alrededor de tu negocio</p>
              </ion-label>
            </ion-item>
          </div>
        </div>

        <!-- Bot√≥n para configurar geocerca -->
        <div class="settings-item clickable" (click)="openGeofenceConfigModal()">
          <div class="item-icon">
            <ion-icon name="navigate-circle-outline" color="primary"></ion-icon>
          </div>
          <div class="item-content">
            <div class="item-label">
              {{ hasGeofence ? 'Editar Geocerca' : 'Configurar Geocerca' }}
            </div>
            <p class="item-description">
              {{ hasGeofence ? 'Modifica tu radio y notificaciones' : 'Define tu √°rea de influencia' }}
            </p>
          </div>
          <ion-icon name="chevron-forward-outline" color="medium"></ion-icon>
        </div>

        <!-- Bot√≥n para crear/editar promoci√≥n -->
        <div class="settings-item clickable" (click)="openPromotionModal()">
          <div class="item-icon">
            <ion-icon name="gift-outline" color="tertiary"></ion-icon>
          </div>
          <div class="item-content">
            <div class="item-label">
              {{ hasPromotion ? 'Editar Promoci√≥n' : 'Crear Promoci√≥n' }}
            </div>
            <p class="item-description">
              {{ hasPromotion ? currentPromotion?.text : 'Atrae clientes con ofertas geogr√°ficas' }}
            </p>
          </div>
          <ion-icon name="chevron-forward-outline" color="medium"></ion-icon>
        </div>

          <!-- Informaci√≥n adicional -->
          <div class="info-banner" *ngIf="!hasGeofence">
            <ion-icon name="information-circle-outline"></ion-icon>
            <p>Configura tu geocerca para recibir estad√≠sticas de usuarios cercanos y crear promociones segmentadas.</p>
          </div>
        </ion-card-content>
      </ion-card>

    </div> <!-- Cierre del contenedor whatsapp-container -->

    <!-- Botones de acci√≥n -->
    <div class="action-buttons">
      <ion-button expand="block" fill="solid" color="success" type="submit" [disabled]="isLoading">
        <ion-icon name="checkmark" slot="start" *ngIf="!isLoading"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        {{ isLoading ? 'Actualizando...' : 'Actualizar Servicio' }}
      </ion-button>

      <ion-button expand="block" fill="outline" (click)="router.navigate(['/tabs/services'])" [disabled]="isLoading">
        Cancelar
      </ion-button>
    </div>

  </form>

  <!-- Modal para gesti√≥n de productos -->
  <ion-modal [isOpen]="isProductModalOpen" (didDismiss)="closeProductModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ editingProduct ? 'Editar Producto' : 'Nuevo Producto' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeProductModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form (ngSubmit)="saveProduct()" #productForm="ngForm">
          
          <!-- Informaci√≥n b√°sica del producto -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Informaci√≥n del Producto</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Nombre del producto *</ion-label>
                <ion-input [(ngModel)]="productFormData.name" name="productName" required></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Descripci√≥n *</ion-label>
                <ion-textarea [(ngModel)]="productFormData.description" name="productDescription" required rows="3"></ion-textarea>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Categor√≠a *</ion-label>
                <ion-select [(ngModel)]="productFormData.category" name="productCategory" required>
                  <ion-select-option *ngFor="let category of productCategories" [value]="category">
                    {{ category }}
                  </ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Precio</ion-label>
                <ion-input [(ngModel)]="productFormData.price" name="productPrice" type="number" step="0.01" min="0" placeholder="Dejar vac√≠o para consultar precio"></ion-input>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Configuraci√≥n del producto -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Configuraci√≥n</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-checkbox [(ngModel)]="productFormData.featured" name="productFeatured"></ion-checkbox>
                <ion-label>Producto destacado</ion-label>
              </ion-item>

              <ion-item>
                <ion-checkbox [(ngModel)]="productFormData.isActive" name="productActive"></ion-checkbox>
                <ion-label>Producto activo</ion-label>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Stock disponible</ion-label>
                <ion-input [(ngModel)]="productFormData.stock" name="productStock" type="number" min="0" placeholder="Dejar vac√≠o para sin l√≠mite"></ion-input>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Tags -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Etiquetas (Tags)</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Etiquetas (separadas por comas)</ion-label>
                <ion-input [(ngModel)]="productTagsInput" name="productTags" placeholder="ej: oferta, popular, nuevo"></ion-input>
              </ion-item>
              <ion-note color="medium">
                Las etiquetas ayudan a los clientes a encontrar tu producto m√°s f√°cilmente.
              </ion-note>
            </ion-card-content>
          </ion-card>

          <!-- Im√°genes del producto -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>Im√°genes del Producto</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <!-- Im√°genes actuales del producto (si est√° editando) -->
              <div *ngIf="editingProduct?.images && editingProduct.images.length > 0" class="current-product-images">
                <h5>Im√°genes actuales</h5>
                <div class="product-images-grid">
                  <div *ngFor="let image of editingProduct.images; let i = index" class="product-image-item">
                    <img [src]="image" [alt]="editingProduct.name" class="product-image">
                  </div>
                </div>
              </div>

              <!-- Seleccionar nuevas im√°genes -->
              <div class="product-images-section">
                <h5>Agregar nuevas im√°genes</h5>
                <ion-button expand="block" fill="outline" (click)="selectProductImages()">
                  <ion-icon name="camera" slot="start"></ion-icon>
                  {{ productFormData.images.length > 0 ? 'Agregar m√°s im√°genes' : 'Seleccionar im√°genes' }}
                </ion-button>
                
                <p *ngIf="productFormData.images.length === 0" class="no-file-selected">Ning√∫n archivo seleccionado</p>
                <div *ngIf="productFormData.images.length > 0" class="selected-product-files">
                  <p class="file-selected">
                    <ion-icon name="checkmark-circle" color="success"></ion-icon>
                    {{ productFormData.images.length }} imagen(es) seleccionada(s)
                  </p>
                  <div class="selected-images-list">
                    <ion-chip *ngFor="let image of productFormData.images; let i = index" color="primary">
                      <ion-icon name="image"></ion-icon>
                      <ion-label>{{ image.name }}</ion-label>
                      <ion-icon name="close" (click)="productFormData.images.splice(i, 1)"></ion-icon>
                    </ion-chip>
                  </div>
                </div>
              </div>

              <ion-note color="medium">
                Puedes subir m√∫ltiples im√°genes para mostrar diferentes √°ngulos del producto.
              </ion-note>
            </ion-card-content>
          </ion-card>

          <!-- Botones de acci√≥n -->
          <div class="modal-actions">
            <ion-button expand="block" fill="solid" color="success" type="submit" [disabled]="isLoadingProduct">
              <ion-icon name="checkmark" slot="start" *ngIf="!isLoadingProduct"></ion-icon>
              <ion-spinner name="crescent" *ngIf="isLoadingProduct"></ion-spinner>
              {{ isLoadingProduct ? 'Guardando...' : (editingProduct ? 'Actualizar Producto' : 'Crear Producto') }}
            </ion-button>

            <ion-button expand="block" fill="outline" (click)="closeProductModal()" [disabled]="isLoadingProduct">
              Cancelar
            </ion-button>
          </div>

        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal: Configurar Geocerca -->
  <ion-modal #geofenceModal [breakpoints]="[0, 0.5, 0.8, 1]" [initialBreakpoint]="0.8">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Configurar Geocerca</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeGeofenceModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form #geofenceForm="ngForm" (ngSubmit)="saveGeofence()">
          
          <ion-card>
            <ion-card-header>
              <ion-card-title>Configuraci√≥n de √Årea</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Nombre de la Geocerca</ion-label>
                <ion-input 
                  [(ngModel)]="geofenceConfig.name" 
                  name="geofenceName" 
                  required
                  placeholder="Ej: Mi Negocio - Centro"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Radio de Acci√≥n (metros)</ion-label>
                <ion-range 
                  [(ngModel)]="geofenceConfig.radius" 
                  name="geofenceRadius"
                  min="50" 
                  max="5000" 
                  step="50"
                  pin="true"
                  [pinFormatter]="formatRadiusPin">
                  <ion-label slot="start">50m</ion-label>
                  <ion-label slot="end">5km</ion-label>
                </ion-range>
                <p class="range-value">{{ geofenceConfig.radius }}m</p>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Descripci√≥n (Opcional)</ion-label>
                <ion-textarea 
                  [(ngModel)]="geofenceConfig.description" 
                  name="geofenceDescription"
                  rows="2"
                  placeholder="Ej: √Årea principal de cobertura"></ion-textarea>
              </ion-item>

              <div class="settings-divider"></div>

              <h3 class="settings-subtitle">Notificaciones</h3>

              <ion-item>
                <ion-toggle 
                  [(ngModel)]="geofenceConfig.notificationSettings!.onEntry" 
                  name="notifyOnEntry"
                  labelPlacement="start">
                  <ion-label>Notificar al entrar</ion-label>
                </ion-toggle>
              </ion-item>

              <ion-item>
                <ion-toggle 
                  [(ngModel)]="geofenceConfig.notificationSettings!.onExit" 
                  name="notifyOnExit"
                  labelPlacement="start">
                  <ion-label>Notificar al salir</ion-label>
                </ion-toggle>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Tiempo de Espera (minutos)</ion-label>
                <ion-input 
                  [(ngModel)]="geofenceConfig.notificationSettings!.cooldownMinutes" 
                  name="cooldownMinutes"
                  type="number"
                  min="5"
                  max="1440"
                  placeholder="30"></ion-input>
                <ion-note slot="helper">M√≠nimo 5 min, M√°ximo 24 horas</ion-note>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <div class="modal-actions">
            <ion-button expand="block" type="submit" color="success" [disabled]="isLoadingGeofence">
              <ion-spinner name="crescent" *ngIf="isLoadingGeofence"></ion-spinner>
              {{ isLoadingGeofence ? 'Guardando...' : 'Guardar Geocerca' }}
            </ion-button>

            <ion-button 
              expand="block" 
              fill="outline" 
              color="danger" 
              (click)="deleteGeofence()" 
              *ngIf="hasGeofence"
              [disabled]="isLoadingGeofence">
              Eliminar Geocerca
            </ion-button>
          </div>

        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal: Crear/Editar Promoci√≥n -->
  <ion-modal #promotionModal [breakpoints]="[0, 0.5, 0.8, 1]" [initialBreakpoint]="0.8">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ hasPromotion ? 'Editar' : 'Crear' }} Promoci√≥n</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closePromotionModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form #promotionForm="ngForm" (ngSubmit)="savePromotion()">
          
          <ion-card>
            <ion-card-header>
              <ion-card-title>Detalles de la Promoci√≥n</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Texto de la Promoci√≥n *</ion-label>
                <ion-textarea 
                  [(ngModel)]="promotionConfig.promotion_text" 
                  name="promotionText" 
                  required
                  rows="3"
                  maxlength="200"
                  placeholder="Ej: ¬°20% de descuento en todos los productos! V√°lido hoy."></ion-textarea>
                <ion-note slot="helper">{{ promotionConfig.promotion_text?.length || 0 }}/200 caracteres</ion-note>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Radio de Promoci√≥n (metros)</ion-label>
                <ion-range 
                  [(ngModel)]="promotionConfig.promo_radius_meters" 
                  name="promoRadius"
                  min="50" 
                  max="5000" 
                  step="50"
                  pin="true"
                  [pinFormatter]="formatRadiusPin">
                  <ion-label slot="start">50m</ion-label>
                  <ion-label slot="end">5km</ion-label>
                </ion-range>
                <p class="range-value">{{ promotionConfig.promo_radius_meters }}m</p>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Fecha de Inicio *</ion-label>
                <ion-datetime 
                  [(ngModel)]="promotionConfig.startDate" 
                  name="startDate"
                  presentation="date"
                  [min]="getCurrentDate()"
                  required>
                </ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Fecha de Finalizaci√≥n *</ion-label>
                <ion-datetime 
                  [(ngModel)]="promotionConfig.endDate" 
                  name="endDate"
                  presentation="date"
                  [min]="promotionConfig.startDate || getCurrentDate()"
                  required>
                </ion-datetime>
              </ion-item>

              <div class="settings-divider"></div>

              <ion-item>
                <ion-toggle 
                  [(ngModel)]="promotionConfig.isActive" 
                  name="promotionActive"
                  labelPlacement="start">
                  <ion-label>
                    <h3>Promoci√≥n Activa</h3>
                    <p>Los usuarios podr√°n ver esta promoci√≥n en el feed y en la b√∫squeda</p>
                  </ion-label>
                </ion-toggle>
              </ion-item>

              <!-- Info sobre el nuevo sistema de promociones -->
              <ion-item lines="none" class="info-item">
                <ion-icon name="information-circle-outline" slot="start" color="primary"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3 style="font-size: 13px; font-weight: 600; color: var(--ion-color-primary);">
                    üì£ Nueva Estrategia de Promociones
                  </h3>
                  <p style="font-size: 12px; color: var(--ion-color-medium); margin-top: 4px; line-height: 1.4;">
                    Tus promociones aparecer√°n de forma natural en el feed de usuarios que filtren por tu categor√≠a. 
                    Tambi√©n estar√°n disponibles en la secci√≥n "Promociones Cercanas" donde los usuarios controlan qu√© ver.
                  </p>
                </ion-label>
              </ion-item>

              <!-- Estad√≠sticas de alcance mejoradas -->
              <div class="promotion-stats" *ngIf="promotionAudiencePreview">
                <h3 class="stats-title">
                  <ion-icon name="analytics-outline"></ion-icon>
                  üìä Alcance de tu Promoci√≥n
                </h3>
                
              <div class="promotion-stats-grid">
                <div class="promotion-stat-card">
                  <div class="stat-icon">
                    <ion-icon name="people-outline" color="success"></ion-icon>
                  </div>
                  <div class="stat-info">
                    <div class="stat-value">{{ promotionAudiencePreview.activeUsers4h || 0 }}</div>
                    <div class="stat-label">Usuarios activos en 4h</div>
                  </div>
                </div>

                <div class="promotion-stat-card">
                  <div class="stat-icon">
                    <ion-icon name="phone-portrait-outline" color="success"></ion-icon>
                  </div>
                  <div class="stat-info">
                    <div class="stat-value">{{ promotionAudiencePreview.estimatedReach || 0 }}</div>
                    <div class="stat-label">Dispositivos alcanzables</div>
                  </div>
                </div>
              </div>

              <!-- Bot√≥n para probar notificaciones -->
              <ion-button 
                expand="block" 
                fill="outline" 
                color="success" 
                (click)="testPromotionNotification()"
                [disabled]="isLoadingPromotion"
                class="test-notification-btn">
                <ion-icon name="notifications-outline" slot="start"></ion-icon>
                Probar Notificaci√≥n Push
              </ion-button>

                <ion-note color="medium" style="display: block; margin-top: 12px; font-size: 11px; text-align: center;">
                  üí° Estos usuarios est√°n en tu radio de cobertura ahora mismo
                </ion-note>

                <ion-button 
                  expand="block"
                  size="small" 
                  fill="outline" 
                  (click)="calculatePromotionReach()"
                  style="margin-top: 12px;">
                  <ion-icon name="refresh-outline" slot="start"></ion-icon>
                  Actualizar Alcance
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>

          <div class="modal-actions">
            <ion-button expand="block" type="submit" color="success" [disabled]="isLoadingPromotion">
              <ion-spinner name="crescent" *ngIf="isLoadingPromotion"></ion-spinner>
              {{ isLoadingPromotion ? 'Guardando...' : 'Guardar Promoci√≥n' }}
            </ion-button>

            <ion-button 
              expand="block" 
              fill="outline" 
              color="danger" 
              (click)="deletePromotion()" 
              *ngIf="hasPromotion"
              [disabled]="isLoadingPromotion">
              Eliminar Promoci√≥n
            </ion-button>
          </div>

        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
