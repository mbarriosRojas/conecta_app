
<ion-header [translucent]="false">
  <ion-toolbar>
    <div class="whatsapp-header">
      <!-- Título -->
      <div class="header-title">
        <h1>Akí</h1>
      </div>
      
      <!-- Contenedor del buscador y filtro -->
      <div class="search-filter-container">
        <ion-searchbar
          [(ngModel)]="searchQuery"
          (ionInput)="onSearch($event)"
          placeholder="Buscar servicios..."
          show-clear-button="focus"
          debounce="300"
          class="whatsapp-searchbar">
        </ion-searchbar>
        
        <!-- Botón de Promociones -->
        <ion-button fill="clear" (click)="goToPromotionsPage()" class="promotions-button">
          <ion-icon name="megaphone" color="tertiary"></ion-icon>
        </ion-button>
        
        <!-- Botón de filtro al lado del buscador -->
        <ion-button fill="clear" (click)="openFilterModal()" class="filter-button">
          <ion-icon name="funnel-outline"></ion-icon>
        </ion-button>
      </div>
    </div>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="false" class="home-content">


  <!-- Banner promocional -->
  <div class="promotional-banner" [style.background-image]="banners.length > 0 ? 'url(' + banners[0].image + ')' : ''">
    <div class="banner-overlay">
      <div class="banner-content">
        <div class="banner-image">
          <!-- Banners dinámicos del API -->
          <div class="banners-slider" #bannersSlider *ngIf="banners.length > 0">
            <div class="swiper-wrapper">
              <div class="swiper-slide" *ngFor="let banner of banners">
                <div class="banner-item" [style.background-image]="'url(' + banner.image + ')'">
                  <div class="banner-overlay" *ngIf="banner.link">
                    <div class="banner-content">
                      <div class="banner-actions">
                        <ion-button fill="solid" color="light" size="small" (click)="openBannerLink(banner.link)">
                          Ver más
                        </ion-button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Paginación -->
            <div class="swiper-pagination"></div>
          </div>
          <!-- Ícono por defecto si no hay banners -->
          <img src="assets/images/service-icon.svg" alt="Servicios" class="service-icon" *ngIf="banners.length === 0">
        </div>
      </div>
    </div>
  </div>

  <!-- Categorías estilo WhatsApp -->
  <div class="categories-section">
    <div class="categories-container">
      <!-- Categoría "Todos" -->
      <div class="whatsapp-category-pill" 
           [class.selected]="!selectedCategory" 
           (click)="selectCategory(null)">
        <ion-icon name="grid-outline" class="category-icon"></ion-icon>
        <span class="category-name">Todos</span>
      </div>
      
      <!-- Categorías del API -->
      <div class="whatsapp-category-pill" 
           *ngFor="let category of categories"
           [class.selected]="selectedCategory?._id === category._id" 
           (click)="selectCategory(category)">
        <img 
          [src]="category.image || 'assets/images/default-category.png'" 
          [alt]="category.name"
          class="category-icon category-image"
          loading="lazy"
          (error)="onImageError($event)">
        <span class="category-name">{{ category.name }}</span>
      </div>
    </div>
  </div>

  <!-- Banner de Promociones Cercanas -->
  <div class="promotions-banner" (click)="goToPromotionsPage()">
    <div class="banner-icon">
      <ion-icon name="megaphone"></ion-icon>
    </div>
    <div class="banner-content">
      <h3>📢 Promociones Cerca de Ti</h3>
      <p>Descubre ofertas exclusivas en tu zona</p>
    </div>
    <ion-icon name="chevron-forward" class="banner-arrow"></ion-icon>
  </div>

  <!-- Sección "Visto recientemente" -->
  <div class="recent-section" *ngIf="recentProviders.length > 0">
    <h3 class="section-title">Visto recientemente</h3>
    <ion-card class="recent-card" *ngFor="let provider of recentProviders.slice(0, 3)" (click)="onProviderClick(provider)">
      <div class="recent-content">
        <img [src]="provider.logo || provider.images[0] || 'assets/images/default-provider.png'" 
             [alt]="provider.name" class="recent-image">
        <div class="recent-info">
          <h4>{{ provider.name }}</h4>
          <p>{{ provider.description | slice:0:50 }}...</p>
          <span class="recent-price">{{ formatDistance(provider.distance || 0) }}</span>
        </div>
      </div>
    </ion-card>
  </div>

  <!-- Lista de servicios y promociones estilo WhatsApp -->
  <div class="whatsapp-services-container" *ngIf="feedItems.length > 0 || providers.length > 0">
    
    <!-- Iterar sobre feedItems si hay promociones mezcladas, sino sobre providers -->
    <ng-container *ngIf="feedItems.length > 0; else providersOnly">
      <ng-container *ngFor="let item of feedItems; trackBy: trackByFeedItemId">
        
        <!-- Mini Promoción -->
        <div class="mini-promotion-card" *ngIf="isPromotion(item)" (click)="goToProvider(item.data.businessID)">
          <div class="promo-header">
            <div class="promo-icon">
              <ion-icon [name]="getPromotionIcon(item.data.type)" color="tertiary"></ion-icon>
            </div>
            <div class="promo-content">
              <h4>📢 {{ item.data.businessName }}</h4>
              <p class="promo-text">{{ item.data.text }}</p>
              <div class="promo-meta">
                <ion-badge color="tertiary" mode="ios">
                  <ion-icon name="megaphone"></ion-icon>
                  Promoción
                </ion-badge>
                <span class="promo-distance">
                  <ion-icon name="location"></ion-icon>
                  {{ item.data.distanceFormatted }}
                </span>
              </div>
            </div>
            <ion-icon name="chevron-forward" color="medium" class="promo-arrow"></ion-icon>
          </div>
        </div>

        <!-- Provider normal -->
        <div class="whatsapp-service-item" *ngIf="!isPromotion(item)" (click)="onProviderClick(item.data)">
      
          <!-- Avatar del servicio -->
          <div class="service-avatar">
            <img 
              [src]="item.data.logo || item.data.images[0] || 'assets/images/default-provider.png'" 
              [alt]="item.data.name"
              class="avatar-image"
              loading="lazy">
            
            <!-- Badges -->
            <div class="avatar-badges">
              <ion-badge *ngIf="item.data.verified" class="verified-badge" color="success">
                <ion-icon name="checkmark-circle"></ion-icon>
              </ion-badge>
              <ion-badge *ngIf="item.data.stand_out" class="featured-badge" color="warning">
                <ion-icon name="star"></ion-icon>
              </ion-badge>
            </div>
          </div>

          <!-- Información del servicio -->
          <div class="service-info">
            <div class="service-header">
              <h3 class="service-name">{{ item.data.name }}</h3>
              <span class="service-time" *ngIf="item.data.distance">{{ formatDistance(item.data.distance) }}</span>
            </div>
            
            <div class="service-message">
              <p class="service-description">{{ item.data.description | slice:0:60 }}{{ item.data.description.length > 60 ? '...' : '' }}</p>
            </div>
            
            <div class="service-meta">
              <div class="meta-item" *ngIf="item.data.address?.city">
                <ion-icon name="location-outline"></ion-icon>
                <span>{{ item.data.address.city }}</span>
              </div>
              
              <div class="meta-item" *ngIf="item.data.rating > 0">
                <ion-icon name="star"></ion-icon>
                <span>{{ item.data.rating | number:'1.1-1' }}</span>
              </div>
              
              <div class="meta-item">
                <ion-icon name="eye-outline"></ion-icon>
                <span>{{ item.data.views }}</span>
              </div>
            </div>
          </div>

          <!-- Indicador de estado -->
          <div class="service-status">
            <div class="status-indicator" *ngIf="item.data.verified"></div>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <!-- Fallback: Mostrar solo providers si no hay feedItems -->
    <ng-template #providersOnly>
      <div class="whatsapp-service-item" 
           *ngFor="let provider of providers; trackBy: trackByProviderId" 
           (click)="onProviderClick(provider)">
        
        <!-- Avatar del servicio -->
        <div class="service-avatar">
          <img 
            [src]="provider.logo || provider.images[0] || 'assets/images/default-provider.png'" 
            [alt]="provider.name"
            class="avatar-image"
            loading="lazy">
          
          <!-- Badges -->
          <div class="avatar-badges">
            <ion-badge *ngIf="provider.verified" class="verified-badge" color="success">
              <ion-icon name="checkmark-circle"></ion-icon>
            </ion-badge>
            <ion-badge *ngIf="provider.stand_out" class="featured-badge" color="warning">
              <ion-icon name="star"></ion-icon>
            </ion-badge>
          </div>
        </div>

        <!-- Información del servicio -->
        <div class="service-info">
          <div class="service-header">
            <h3 class="service-name">{{ provider.name }}</h3>
            <span class="service-time" *ngIf="provider.distance">{{ formatDistance(provider.distance) }}</span>
          </div>
          
          <div class="service-message">
            <p class="service-description">{{ provider.description | slice:0:60 }}{{ provider.description.length > 60 ? '...' : '' }}</p>
          </div>
          
          <div class="service-meta">
            <div class="meta-item" *ngIf="provider.address?.city">
              <ion-icon name="location-outline"></ion-icon>
              <span>{{ provider.address.city }}</span>
            </div>
            
            <div class="meta-item" *ngIf="provider.rating > 0">
              <ion-icon name="star"></ion-icon>
              <span>{{ provider.rating | number:'1.1-1' }}</span>
            </div>
            
            <div class="meta-item">
              <ion-icon name="eye-outline"></ion-icon>
              <span>{{ provider.views }}</span>
            </div>
          </div>
        </div>

        <!-- Indicador de estado -->
        <div class="service-status">
          <div class="status-indicator" *ngIf="provider.verified"></div>
        </div>
      </div>
    </ng-template>
  </div>
  <!-- Botón Ver Más -->
  <div class="load-more-container" *ngIf="hasMoreData && !isLoading && !isLoadingMore">
    <ion-button 
      size="small"
      fill="clear" 
      color="primary"
      (click)="loadMoreProviders()"
      [disabled]="isLoadingMore"
      class="load-more-button">
      <ion-spinner *ngIf="isLoadingMore" name="crescent" slot="start"></ion-spinner>
      <ion-icon *ngIf="!isLoadingMore" name="chevron-down" slot="start"></ion-icon>
      {{ isLoadingMore ? 'Cargando...' : 'Ver más' }}
    </ion-button>
  </div>

  <!-- Indicador de carga cuando está cargando más -->
  <div class="loading-more-container" *ngIf="isLoadingMore">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando más servicios...</p>
  </div>


  <!-- Componente de no resultados (tipo Tinder) -->
  <app-no-results-expand
    *ngIf="showNoResults && !isLoading"
    [searchQuery]="searchQuery"
    [currentRadius]="currentRadius"
    [isLoading]="isExpandingRadius"
    (expandRadius)="onExpandRadius($event)"
    (retrySearch)="onRetrySearch()">
  </app-no-results-expand>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Desliza para actualizar"
      refreshingSpinner="circles"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Modal de filtros -->
  <ion-modal [isOpen]="showFilterModal" (didDismiss)="closeFilterModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Filtros</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeFilterModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="filter-modal-content">
          <!-- Category Filter -->
          <ion-item>
            <ion-label>Categoría</ion-label>
            <ion-select 
              [(ngModel)]="tempSelectedCategory" 
              placeholder="Todas las categorías"
              interface="popover">
              <ion-select-option [value]="null">Todos</ion-select-option>
              <ion-select-option *ngFor="let category of categories" [value]="category">
                {{ category.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- City Filter -->
          <ion-item>
            <ion-label>Ciudad</ion-label>
            <ion-select 
              [(ngModel)]="tempSelectedCity" 
              placeholder="Todas las ciudades"
              interface="popover">
              <ion-select-option value="">Todas las ciudades</ion-select-option>
              <ion-select-option *ngFor="let city of cities" [value]="city">
                {{ city }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Radius Filter -->
          <ion-item>
            <ion-label>Radio de búsqueda</ion-label>
            <ion-range 
              [(ngModel)]="tempSelectedRadius" 
              min="1000" 
              max="500000000" 
              step="1000"
              color="primary">
              <ion-label slot="start">1km</ion-label>
              <ion-label slot="end">{{ (tempSelectedRadius / 1000) }}km</ion-label>
            </ion-range>
          </ion-item>

          <!-- Location Filter Button -->
          <!--<ion-item button (click)="openLocationModal()">
            <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Ubicación</h3>
              <p>{{ tempSelectedLocationName || 'Usar ubicación actual' }}</p>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>-->

          <!-- Clear Filters -->
          <ion-button 
            expand="block" 
            fill="outline" 
            (click)="clearFilters()"
            class="clear-filters-btn">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Limpiar Filtros
          </ion-button>

          <!-- Apply Filters Button -->
          <ion-button 
            expand="block" 
            fill="solid" 
            color="primary"
            (click)="applyFilters()"
            class="apply-filters-btn">
            <ion-icon name="checkmark" slot="start"></ion-icon>
            Aplicar Filtros
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal de selección de ubicación -->
  <ion-modal [isOpen]="showLocationModal" (didDismiss)="closeLocationModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Cambiar ubicación</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeLocationModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="location-modal-content">
          <!-- Búsqueda de ubicación -->
          <div class="location-search">
            <ion-item>
              <ion-label position="stacked">Buscar por ciudad, localidad o código postal</ion-label>
              <ion-input 
                [(ngModel)]="locationSearchQuery" 
                placeholder="Ej: Mérida, Venezuela"
                (ionInput)="onLocationSearch($event)">
              </ion-input>
            </ion-item>
            
            <!-- Sugerencias de ubicación -->
            <div class="location-suggestions" *ngIf="locationSuggestions.length > 0">
              <ion-item 
                *ngFor="let suggestion of locationSuggestions" 
                button 
                (click)="selectLocation(suggestion)"
                class="suggestion-item">
                <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>{{ suggestion.name }}</h3>
                  <p>{{ suggestion.formatted_address }}</p>
                </ion-label>
              </ion-item>
            </div>
            
            <ion-item>
              <ion-icon name="location-outline" slot="start"></ion-icon>
              <ion-label>Ubicación seleccionada</ion-label>
              <ion-note slot="end">{{ selectedLocationName || 'Ninguna' }}</ion-note>
            </ion-item>
          </div>

          <!-- Selector de radio -->
          <div class="radius-selector">
            <ion-item>
              <ion-label>Radio</ion-label>
              <ion-select 
                [(ngModel)]="tempSelectedRadius" 
                interface="popover">
                <ion-select-option value="1000">1 kilómetro</ion-select-option>
                <ion-select-option value="2000">2 kilómetros</ion-select-option>
                <ion-select-option value="5000">5 kilómetros</ion-select-option>
                <ion-select-option value="10000">10 kilómetros</ion-select-option>
                <ion-select-option value="15000">15 kilómetros</ion-select-option>
                <ion-select-option value="20000">20 kilómetros</ion-select-option>
                <ion-select-option value="30000">30 kilómetros</ion-select-option>
                <ion-select-option value="50000">50 kilómetros</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <!-- Mapa con radar -->
          <div class="map-container">
            <div class="map-header">
              <h3>Área de cobertura</h3>
              <p>{{ formatDistance(selectedRadius) }} de radio</p>
            </div>
            
            <div class="map-wrapper">
              <!-- Mapa principal -->
              <div class="map-container-main">
                <iframe
                  [src]="getLocationMapUrl()"
                  width="100%"
                  height="300"
                  style="border:0; border-radius: 12px;"
                  allowfullscreen=""
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  (error)="onMapError($event)">
                </iframe>
                
                <!-- Overlay con información del radar -->
                <div class="radar-overlay">
                  <div class="radar-info">
                    <ion-icon name="radio-outline"></ion-icon>
                    <span>Radio: {{ formatDistance(selectedRadius) }}</span>
                  </div>
                </div>
                
                <!-- Indicador de radio en el mapa -->
                <div class="radius-indicator" *ngIf="selectedLocation">
                  <div class="radius-circle" [style.width.px]="getMapRadiusSize()" [style.height.px]="getMapRadiusSize()">
                    <div class="radius-center">
                      <ion-icon name="location" color="danger"></ion-icon>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Información de ubicación -->
              <div class="location-info-card" *ngIf="selectedLocation">
                <div class="location-details">
                  <ion-icon name="location-outline" color="primary"></ion-icon>
                  <div class="location-text">
                    <h4>{{ selectedLocation.name }}</h4>
                    <p>Área de cobertura: {{ formatDistance(selectedRadius) }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="location-actions">
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="useCurrentLocation()"
              [disabled]="!currentLocation">
              <ion-icon name="locate" slot="start"></ion-icon>
              Usar mi ubicación actual
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="solid" 
              color="primary"
              (click)="applyLocationFilter()">
              <ion-icon name="checkmark" slot="start"></ion-icon>
              Aplicar
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>