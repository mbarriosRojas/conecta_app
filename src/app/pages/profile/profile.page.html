
<ion-content [fullscreen]="false" class="profile-content">
  <div class="profile-container" *ngIf="user && !isLoading">
    
    <!-- Header del perfil -->
    <div class="profile-header">
      <div class="profile-avatar-container">
        <img 
          [src]="user.profileImage || 'assets/icon/aki-logo.svg'" 
          alt="Foto de perfil"
          class="profile-avatar">
        <button class="change-photo-btn" (click)="changeProfilePicture()">
          <ion-icon name="camera-outline"></ion-icon>
        </button>
      </div>
      
      <div class="profile-info">
        <h2>{{ user.name }} {{ user.lastname }}</h2>
        <p class="user-email">{{ user.email }}</p>
      </div>
    </div>

    <!-- Datos del usuario -->
    <div class="profile-data">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="person-outline"></ion-icon>
            Informaci贸n Personal
          </ion-card-title>
          <ion-button 
            *ngIf="!isEditing" 
            fill="clear" 
            size="small" 
            (click)="toggleEdit()">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
        </ion-card-header>

        <ion-card-content>
          <div class="data-grid">
            
            <!-- Nombre -->
            <div class="data-item">
              <label>Nombre</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.name"
                placeholder="Nombre"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.name }}</span>
            </div>

            <!-- Apellido -->
            <div class="data-item">
              <label>Apellido</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.lastname"
                placeholder="Apellido"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.lastname }}</span>
            </div>

            <!-- Email -->
            <div class="data-item">
              <label>Email</label>
              <span class="data-value email-value">{{ user.email }}</span>
              <ion-note>El email no se puede cambiar</ion-note>
            </div>

            <!-- Tel茅fono -->
            <div class="data-item">
              <label>Tel茅fono</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.phone"
                placeholder="Tel茅fono"
                type="tel"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.phone || 'No especificado' }}</span>
            </div>


          </div>

          <!-- Botones de acci贸n -->
          <div class="edit-actions" *ngIf="isEditing">
            <ion-button 
              expand="block" 
              (click)="saveProfile()" 
              [disabled]="isLoading"
              class="save-btn">
              <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
              <span *ngIf="!isLoading">Guardar Cambios</span>
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="toggleEdit()"
              class="cancel-btn">
              Cancelar
            </ion-button>
          </div>

          <!-- Bot贸n de cambiar contrase帽a -->
          <div class="security-section" *ngIf="!isEditing">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="warning"
              (click)="openChangePasswordAlert()"
              class="change-password-btn">
              <ion-icon name="key-outline" slot="start"></ion-icon>
              Cambiar Contrase帽a
            </ion-button>
          </div>

          <!-- Bot贸n de cerrar sesi贸n -->
          <div class="logout-section" *ngIf="!isEditing">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="danger"
              (click)="logout()"
              class="logout-btn">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              Cerrar Sesi贸n
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!--  Secci贸n de Plan y Suscripci贸n -->
      <ion-card *ngIf="!isEditing && currentSubscription">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="card-outline"></ion-icon>
            Plan Actual
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="plan-info">
            <h2 class="plan-name">{{ currentSubscription.planID.name }}</h2>
            <p class="plan-description">{{ currentSubscription.planID.description }}</p>
            <p class="plan-price" *ngIf="currentSubscription.planID.price > 0">
              ${{ currentSubscription.planID.price }} {{ currentSubscription.planID.currency }}/mes
            </p>
            <p class="plan-price" *ngIf="currentSubscription.planID.price === 0">
              Gratis
            </p>
          </div>

          <!-- L铆mites del plan -->
          <div class="limits-section">
            <h3>L铆mites de tu plan:</h3>
            <ion-list>
              <ion-item>
                <ion-label>
                  <h3>Servicios</h3>
                  <p>
                    {{ currentSubscription.currentLimits.services.used }} / 
                    {{ getLimitDisplay(currentSubscription.currentLimits.services.limit) }}
                    <span *ngIf="currentSubscription.currentLimits.services.remaining >= 0 && currentSubscription.currentLimits.services.limit !== -1" 
                          class="remaining-badge">
                      ({{ currentSubscription.currentLimits.services.remaining }} restantes)
                    </span>
                  </p>
                </ion-label>
              </ion-item>
              
              <ion-item>
                <ion-label>
                  <h3>Promociones por Servicio</h3>
                  <p>{{ getLimitDisplay(currentSubscription.currentLimits.promotionsPerService.limit) }}</p>
                </ion-label>
              </ion-item>
              
              <ion-item>
                <ion-label>
                  <h3>Productos por Servicio</h3>
                  <p>{{ getLimitDisplay(currentSubscription.currentLimits.productsPerService.limit) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>

          <!-- Fecha de vencimiento -->
          <div class="subscription-date" *ngIf="currentSubscription.endDate">
            <ion-note>
              Vence el {{ currentSubscription.endDate | date:'dd/MM/yyyy' }}
            </ion-note>
          </div>

          <!-- Acciones del plan -->
          <div class="plan-actions">
            <ion-button 
              expand="block" 
              fill="solid"
              color="primary"
              (click)="openChangePlanModal()"
              class="change-plan-btn">
              <ion-icon name="swap-horizontal-outline" slot="start"></ion-icon>
              Cambiar Plan
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline"
              color="medium"
              (click)="reportPayment()"
              class="report-payment-btn">
              <ion-icon name="cash-outline" slot="start"></ion-icon>
              Reportar Pago
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!--  Secci贸n de Notificaciones -->
      <ion-card *ngIf="!isEditing && notificationSettings">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="notifications-outline"></ion-icon>
            Notificaciones
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="none" [button]="false">
              <ion-label slot="start">
                <h2>Activar Notificaciones</h2>
                <p>Recibir notificaciones push en tu dispositivo</p>
              </ion-label>
              <ion-toggle 
                slot="end"
                [checked]="notificationSettings.notificationsEnabled"
                (ionChange)="toggleNotifications($event)">
              </ion-toggle>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>
</ion-content>
