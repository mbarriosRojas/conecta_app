
<ion-content [fullscreen]="false" class="profile-content">
  <div class="profile-container" *ngIf="user && !isLoading">
    
    <!-- Header del perfil -->
    <div class="profile-header">
      <div class="profile-avatar-container">
        <img 
          [src]="user.profileImage || 'assets/icon/aki-logo.svg'" 
          alt="Foto de perfil"
          class="profile-avatar">
        <button class="change-photo-btn" (click)="changeProfilePicture()">
          <ion-icon name="camera-outline"></ion-icon>
        </button>
      </div>
      
      <div class="profile-info">
        <h2>{{ user.name }} {{ user.lastname }}</h2>
        <p class="user-email">{{ user.email }}</p>
      </div>
    </div>

    <!-- Datos del usuario -->
    <div class="profile-data">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="person-outline"></ion-icon>
            Informaci√≥n Personal
          </ion-card-title>
          <ion-button 
            *ngIf="!isEditing" 
            fill="clear" 
            size="small" 
            (click)="toggleEdit()">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
        </ion-card-header>

        <ion-card-content>
          <div class="data-grid">
            
            <!-- Nombre -->
            <div class="data-item">
              <label>Nombre</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.name"
                placeholder="Nombre"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.name }}</span>
            </div>

            <!-- Apellido -->
            <div class="data-item">
              <label>Apellido</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.lastname"
                placeholder="Apellido"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.lastname }}</span>
            </div>

            <!-- Email -->
            <div class="data-item">
              <label>Email</label>
              <span class="data-value email-value">{{ user.email }}</span>
              <ion-note>El email no se puede cambiar</ion-note>
            </div>

            <!-- Tel√©fono -->
            <div class="data-item">
              <label>Tel√©fono</label>
              <ion-input 
                *ngIf="isEditing"
                [(ngModel)]="editData.phone"
                placeholder="Tel√©fono"
                type="tel"
                class="edit-input">
              </ion-input>
              <span *ngIf="!isEditing" class="data-value">{{ user.phone || 'No especificado' }}</span>
            </div>


          </div>

          <!-- Botones de acci√≥n -->
          <div class="edit-actions" *ngIf="isEditing">
            <ion-button 
              expand="block" 
              (click)="saveProfile()" 
              [disabled]="isLoading"
              class="save-btn">
              <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
              <span *ngIf="!isLoading">Guardar Cambios</span>
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="toggleEdit()"
              class="cancel-btn">
              Cancelar
            </ion-button>
          </div>

          <!-- Bot√≥n de cambiar contrase√±a -->
          <div class="security-section" *ngIf="!isEditing">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="warning"
              (click)="openChangePasswordAlert()"
              class="change-password-btn">
              <ion-icon name="key-outline" slot="start"></ion-icon>
              Cambiar Contrase√±a
            </ion-button>
          </div>

          <!-- Bot√≥n de cerrar sesi√≥n -->
          <div class="logout-section" *ngIf="!isEditing">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="danger"
              (click)="logout()"
              class="logout-btn">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              Cerrar Sesi√≥n
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- üí≥ Secci√≥n de Plan y Suscripci√≥n -->
      <!-- Cuando el usuario tiene un plan activo -->
      <ion-card *ngIf="!isEditing && currentSubscription">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="card-outline"></ion-icon>
            Plan Actual
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- üî• NUEVO: Badge de estado pendiente -->
          <div class="pending-payment-badge" *ngIf="currentSubscription.status === 'pending'">
            <ion-icon name="time-outline"></ion-icon>
            <span>Esperando confirmaci√≥n de pago</span>
          </div>

          <div class="plan-info">
            <h2 class="plan-name">{{ currentSubscription.planID.name }}</h2>
            <p class="plan-description">{{ currentSubscription.planID.description }}</p>
            <p class="plan-price" *ngIf="currentSubscription.planID.price > 0">
              ${{ currentSubscription.planID.price }} {{ currentSubscription.planID.currency }}/mes
            </p>
            <p class="plan-price" *ngIf="currentSubscription.planID.price === 0">
              Gratis
            </p>
          </div>

          <!-- L√≠mites del plan -->
          <div class="limits-section">
            <h3>L√≠mites de tu plan:</h3>
            <ion-list>
              <ion-item>
                <ion-label>
                  <h3>Servicios</h3>
                  <p>
                    {{ currentSubscription.currentLimits.services.used }} / 
                    {{ getLimitDisplay(currentSubscription.currentLimits.services.limit) }}
                    <span *ngIf="currentSubscription.currentLimits.services.remaining >= 0 && currentSubscription.currentLimits.services.limit !== -1" 
                          class="remaining-badge">
                      ({{ currentSubscription.currentLimits.services.remaining }} restantes)
                    </span>
                  </p>
                </ion-label>
              </ion-item>
              
              <ion-item>
                <ion-label>
                  <h3>Promociones por Servicio</h3>
                  <p>{{ getLimitDisplay(currentSubscription.currentLimits.promotionsPerService.limit) }}</p>
                </ion-label>
              </ion-item>
              
              <ion-item>
                <ion-label>
                  <h3>Productos por Servicio</h3>
                  <p>{{ getLimitDisplay(currentSubscription.currentLimits.productsPerService.limit) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>

          <!-- Fecha de vencimiento -->
          <div class="subscription-date" *ngIf="currentSubscription.endDate">
            <ion-note>
              Vence el {{ currentSubscription.endDate | date:'dd/MM/yyyy' }}
            </ion-note>
          </div>

          <!-- Acciones del plan -->
          <div class="plan-actions">
            <ion-button 
              expand="block" 
              fill="solid"
              color="primary"
              (click)="openChangePlanModal()"
              class="change-plan-btn">
              <ion-icon name="swap-horizontal-outline" slot="start"></ion-icon>
              Cambiar Plan
            </ion-button>
            
            <!-- Mostrar bot√≥n de reportar pago solo si la suscripci√≥n est√° pendiente -->
            <ion-button 
              *ngIf="currentSubscription && currentSubscription.status === 'pending'"
              expand="block" 
              fill="outline"
              color="warning"
              (click)="reportPayment()"
              class="report-payment-btn">
              <ion-icon name="cash-outline" slot="start"></ion-icon>
              Reportar Pago
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Cuando el usuario NO tiene un plan activo -->
      <ion-card *ngIf="!isEditing && !currentSubscription && availablePlans.length > 0">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="card-outline"></ion-icon>
            Plan de Suscripci√≥n
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="no-plan-message">
            <ion-icon name="information-circle-outline" color="warning" size="large"></ion-icon>
            <h2>No tienes un plan activo</h2>
            <p>Selecciona un plan para comenzar a crear servicios y promociones.</p>
          </div>

          <!-- Lista de planes disponibles -->
          <div class="available-plans-list">
            <h3>Planes Disponibles:</h3>
            <ion-list>
              <ion-item *ngFor="let plan of availablePlans" button (click)="selectPlan(plan.code)" class="plan-item">
                <ion-label>
                  <h2>{{ plan.name }}</h2>
                  <p>{{ plan.description }}</p>
                  <p class="plan-price-item">
                    <strong *ngIf="plan.price > 0">${{ plan.price }} {{ plan.currency }}/mes</strong>
                    <strong *ngIf="plan.price === 0">Gratis</strong>
                  </p>
                  <div class="plan-features">
                    <ion-note>
                      ‚Ä¢ {{ plan.limits.services === -1 ? 'Servicios: Ilimitados' : plan.limits.services + ' Servicios' }}
                      ‚Ä¢ {{ plan.limits.promotionsPerService === -1 ? 'Promociones: Ilimitadas' : plan.limits.promotionsPerService + ' Promociones por servicio' }}
                      ‚Ä¢ {{ plan.limits.productsPerService === -1 ? 'Productos: Ilimitados' : plan.limits.productsPerService + ' Productos por servicio' }}
                    </ion-note>
                  </div>
                </ion-label>
                <ion-icon name="chevron-forward-outline" slot="end" color="medium"></ion-icon>
              </ion-item>
            </ion-list>
          </div>

          <!-- Bot√≥n para seleccionar plan -->
          <div class="plan-actions">
            <ion-button 
              expand="block" 
              fill="solid"
              color="primary"
              (click)="openChangePlanModal()"
              class="select-plan-btn">
              <ion-icon name="card-outline" slot="start"></ion-icon>
              Seleccionar Plan
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Cuando no hay planes disponibles -->
      <ion-card *ngIf="!isEditing && !currentSubscription && availablePlans.length === 0">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="card-outline"></ion-icon>
            Plan de Suscripci√≥n
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="no-plan-message">
            <ion-icon name="alert-circle-outline" color="medium" size="large"></ion-icon>
            <h2>No hay planes disponibles</h2>
            <p>Por favor, contacta con soporte para activar un plan.</p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- üîî Secci√≥n de Notificaciones -->
      <ion-card *ngIf="!isEditing && notificationSettings">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="notifications-outline"></ion-icon>
            Notificaciones
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="none" [button]="false">
              <ion-label slot="start">
                <h2>Activar Notificaciones</h2>
                <p>Recibir notificaciones push en tu dispositivo</p>
              </ion-label>
              <ion-toggle 
                slot="end"
                [checked]="notificationSettings.notificationsEnabled"
                (ionChange)="toggleNotifications($event)">
              </ion-toggle>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>
</ion-content>
